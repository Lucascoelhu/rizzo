<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cart-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }
    </style>
</head>
<body class="bg-gray-100 pb-20">

    <header class="bg-green-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <h1 class="text-xl font-bold text-center">üöÄ Delivery Express</h1>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
        <section id="sec-destaques" class="hidden">
            <h2 class="text-lg font-bold text-orange-600 mb-2">üî• Destaques do Dia</h2>
            <div id="lista-destaques" class="grid grid-cols-1 gap-3"></div>
        </section>

        <section>
            <h2 class="text-lg font-bold text-blue-600 mb-2">üèÜ Mais Vendidos</h2>
            <div id="lista-mais-vendidos" class="flex overflow-x-auto gap-4 p-2"></div>
        </section>

        <section>
            <h2 class="text-lg font-bold text-gray-700 mb-2">Card√°pio</h2>
            <div id="lista-geral" class="bg-white rounded-lg shadow divide-y"></div>
        </section>
    </main>

    <div id="carrinho-modal" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-2xl border-t-4 border-green-500 rounded-t-2xl transform translate-y-full transition-transform duration-300 z-50">
        <h3 class="font-bold mb-2">Meu Pedido</h3>
        <div id="itens-carrinho" class="max-h-40 overflow-y-auto mb-4 text-sm"></div>
        <input id="cli-nome" type="text" placeholder="Nome" class="w-full border p-2 rounded mb-2">
        <input id="cli-whats" type="text" placeholder="WhatsApp" class="w-full border p-2 rounded mb-2">
        <input id="cli-end" type="text" placeholder="Endere√ßo e N√∫mero" class="w-full border p-2 rounded mb-2">
        <button onclick="finalizarPedido()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg text-lg">Enviar Pedido via Sistema</button>
        <button onclick="toggleCarrinho()" class="w-full text-gray-500 mt-2 text-sm">Fechar</button>
    </div>

    <button onclick="toggleCarrinho()" class="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-2xl">
        üõí <span id="cart-count" class="cart-badge">0</span>
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, limit, increment, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { /* COLE AQUI */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let carrinho = [];

        // Carregar Produtos em Tempo Real
        onSnapshot(collection(db, "produtos"), (snapshot) => {
            const geral = document.getElementById('lista-geral');
            const destaques = document.getElementById('lista-destaques');
            const secDestaque = document.getElementById('sec-destaques');
            
            geral.innerHTML = ''; destaques.innerHTML = '';
            let temDestaque = false;

            snapshot.forEach(res => {
                const p = res.data();
                const id = res.id;
                const precoFinal = p.preco - p.desconto;
                const html = `
                    <div class="p-4 flex justify-between items-center">
                        <div>
                            <p class="font-bold">${p.nome}</p>
                            <p class="text-green-600 text-sm">R$ ${precoFinal.toFixed(2)} ${p.desconto > 0 ? `<span class="text-red-400 line-through text-xs">R$ ${p.preco}</span>` : ''}</p>
                        </div>
                        <button onclick="addCarrinho('${id}', '${p.nome}', ${precoFinal})" class="bg-green-100 text-green-700 px-4 py-1 rounded-full font-bold">+ Add</button>
                    </div>`;

                if(p.destaque) {
                    destaques.innerHTML += html;
                    temDestaque = true;
                }
                geral.innerHTML += html;
            });
            secDestaque.style.display = temDestaque ? 'block' : 'none';
        });

        // Carregar Mais Vendidos (Top 5 por vendas)
        onSnapshot(query(collection(db, "produtos"), orderBy("vendas", "desc"), limit(5)), (snapshot) => {
            const mv = document.getElementById('lista-mais-vendidos');
            mv.innerHTML = '';
            snapshot.forEach(res => {
                const p = res.data();
                if(p.vendas > 0) {
                    mv.innerHTML += `<div class="min-w-[120px] bg-white p-3 rounded-lg shadow text-center border-b-2 border-blue-400">
                        <p class="text-xs font-bold truncate">${p.nome}</p>
                        <p class="text-blue-500 text-sm font-bold">R$ ${(p.preco - p.desconto).toFixed(2)}</p>
                    </div>`;
                }
            });
        });

        window.addCarrinho = (id, nome, preco) => {
            carrinho.push({id, nome, preco});
            updateCartUI();
        };

        function updateCartUI() {
            document.getElementById('cart-count').innerText = carrinho.length;
            document.getElementById('itens-carrinho').innerHTML = carrinho.map(i => `<div>‚Ä¢ ${i.nome} - R$ ${i.preco.toFixed(2)}</div>`).join('');
        }

        window.toggleCarrinho = () => {
            const modal = document.getElementById('carrinho-modal');
            modal.style.transform = modal.style.transform === 'translateY(0%)' ? 'translateY(100%)' : 'translateY(0%)';
        };

        window.finalizarPedido = async () => {
            const nome = document.getElementById('cli-nome').value;
            if(!nome || carrinho.length === 0) return alert("Preencha seu nome e adicione itens!");

            const pedido = {
                cliente: nome,
                whats: document.getElementById('cli-whats').value,
                endereco: document.getElementById('cli-end').value,
                itens: carrinho,
                total: carrinho.reduce((acc, i) => acc + i.preco, 0),
                status: "pendente",
                data: new Date()
            };

            // Salvar Pedido e Incrementar Vendas
            await addDoc(collection(db, "pedidos"), pedido);
            carrinho.forEach(async item => {
                await updateDoc(doc(db, "produtos", item.id), { vendas: increment(1) });
            });

            alert("Pedido enviado!");
            carrinho = [];
            updateCartUI();
            toggleCarrinho();
        };
    </script>
</body>
</html>
