<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Bill Rizzo | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: none; }
        
        /* Mobile otimizado */
        .mobile-card { 
            background: rgba(30, 41, 59, 0.8); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Status indicators */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-pendente { background: #f59e0b; }
        .status-recebido { background: #10b981; }
        .status-cancelado { background: #ef4444; }
        
        /* Touch targets */
        .touch-btn { min-height: 44px; min-width: 44px; }
        
        /* Animações */
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* Bottom nav mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Receipt/Cupom elegante */
        .receipt-elegant {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            position: relative;
        }
        
        .receipt-elegant::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: radial-gradient(circle, transparent 6px, #ffffff 6px);
            background-size: 20px 20px;
            background-position: -10px 0;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.error { background: #ef4444; }
        
        /* Modal otimizado */
        .modal-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0f172a;
            border-radius: 24px 24px 0 0;
            z-index: 60;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-sheet.active { transform: translateY(0); }
        
        /* Contador de dias */
        .days-counter {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 16px;
            padding: 16px;
            color: white;
            text-align: center;
        }
        
        .days-counter.warning {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
        }
        
        .days-counter.danger {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }
        
        .days-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }
        
        /* Ativação input */
        .ativacao-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 20px;
            letter-spacing: 4px;
            text-align: center;
            text-transform: uppercase;
            font-family: 'Courier New', monospace;
        }
        
        .ativacao-input:focus {
            border-color: #10b981;
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <!-- Toast -->
    <div id="toast" class="toast">
        <span id="toast-msg">Operação realizada!</span>
    </div>

    <!-- Header -->
    <header class="fixed top-0 w-full bg-slate-900/95 backdrop-blur-md border-b border-slate-800 z-40">
        <div class="max-w-lg mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-crown text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold">Bill Rizzo</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Painel Admin</p>
                </div>
            </div>
            <a href="https://wa.me/5512988600188" target="_blank" class="p-2 text-green-400 hover:text-green-300">
                <i class="fab fa-whatsapp text-xl"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-16 pb-24 max-w-lg mx-auto px-4 space-y-4">

        <!-- Status da Assinatura -->
        <div class="mobile-card rounded-2xl p-4 animate-fade-in">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-slate-300">Status do Sistema</h3>
                <span id="status-badge" class="px-2 py-1 rounded-full text-xs font-medium bg-emerald-500/20 text-emerald-400">
                    Ativo
                </span>
            </div>
            
            <div id="days-container" class="days-counter">
                <div class="days-number" id="dias-restantes">--</div>
                <p class="text-sm opacity-90 mt-1">dias restantes</p>
            </div>
            
            <div class="mt-4 pt-4 border-t border-slate-700">
                <p class="text-xs text-slate-500 mb-2">Ativar novo código:</p>
                <div class="flex gap-2">
                    <input type="text" id="novo-codigo" placeholder="XXXX-XXXX-XXXX" 
                        class="ativacao-input flex-1 px-4 py-3 rounded-xl text-center"
                        maxlength="14">
                    <button onclick="ativarNovoCodigo()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 rounded-xl font-semibold">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
                <span>Código atual: <span id="codigo-atual" class="text-slate-300 font-mono">---</span></span>
                <span>Expira: <span id="data-expira" class="text-slate-300">---</span></span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
            <button onclick="showTab('dashboard')" id="tab-btn-dashboard" class="tab-btn px-4 py-2 rounded-xl text-sm font-medium bg-blue-600 text-white whitespace-nowrap">
                <i class="fas fa-chart-line mr-1"></i> Resumo
            </button>
            <button onclick="showTab('pedidos')" id="tab-btn-pedidos" class="tab-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-800 text-slate-400 whitespace-nowrap">
                <i class="fas fa-shopping-bag mr-1"></i> Pedidos
                <span id="badge-pedidos" class="ml-1 bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
            </button>
            <button onclick="showTab('produtos')" id="tab-btn-produtos" class="tab-btn px-4 py-2 rounded-xl text-sm font-medium bg-slate-800 text-slate-400 whitespace-nowrap">
                <i class="fas fa-box mr-1"></i> Produtos
            </button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dashboard" class="tab-content space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="mobile-card rounded-xl p-4 text-center">
                    <p class="text-slate-400 text-xs mb-1">Hoje</p>
                    <p class="text-xl font-bold text-white" id="dash-hoje">R$ 0,00</p>
                    <p class="text-xs text-slate-500 mt-1"><span id="count-hoje">0</span> pedidos</p>
                </div>
                <div class="mobile-card rounded-xl p-4 text-center">
                    <p class="text-slate-400 text-xs mb-1">Pendentes</p>
                    <p class="text-xl font-bold text-amber-400" id="dash-pendentes">0</p>
                    <p class="text-xs text-slate-500 mt-1">aguardando</p>
                </div>
            </div>
            
            <div class="mobile-card rounded-xl p-4">
                <h3 class="font-semibold mb-3 text-slate-300">Produtos Mais Vendidos</h3>
                <div id="ranking-produtos" class="space-y-2">
                    <p class="text-slate-500 text-sm text-center py-4">Sem dados</p>
                </div>
            </div>
        </div>

        <!-- Pedidos -->
        <div id="tab-pedidos" class="tab-content hidden space-y-3">
            <!-- Filtros -->
            <div class="flex gap-2 overflow-x-auto pb-2">
                <button onclick="filtrarPedidos('todos')" class="filtro-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-600 text-white" data-filter="todos">Todos</button>
                <button onclick="filtrarPedidos('pendente')" class="filtro-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-800 text-slate-400" data-filter="pendente">Pendentes</button>
                <button onclick="filtrarPedidos('recebido')" class="filtro-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-800 text-slate-400" data-filter="recebido">Recebidos</button>
            </div>
            
            <div id="lista-pedidos" class="space-y-2"></div>
        </div>

        <!-- Produtos -->
        <div id="tab-produtos" class="tab-content hidden space-y-4">
            <!-- Add Produto -->
            <div class="mobile-card rounded-xl p-4">
                <h3 class="font-semibold mb-3 text-slate-300">Novo Produto</h3>
                <div class="space-y-3">
                    <input id="p-nome" type="text" placeholder="Nome do produto" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-white">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="p-preco" type="number" step="0.01" placeholder="Preço R$" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-white">
                        <input id="p-desconto" type="number" step="0.01" placeholder="Desconto R$" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-white">
                    </div>
                    <div class="flex gap-3 text-sm">
                        <label class="flex items-center gap-2">
                            <input id="p-destaque" type="checkbox" class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-blue-500">
                            <span class="text-slate-400">Destaque</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input id="p-ativo" type="checkbox" checked class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-emerald-500">
                            <span class="text-slate-400">Visível</span>
                        </label>
                    </div>
                    <button onclick="salvarProduto()" id="btn-salvar-prod" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg text-sm">
                        <i class="fas fa-plus mr-1"></i> Cadastrar Produto
                    </button>
                </div>
            </div>
            
            <!-- Lista Produtos -->
            <div id="lista-produtos" class="space-y-2"></div>
        </div>

    </main>

    <!-- Modal Pedido -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 z-50 hidden opacity-0 transition-opacity" onclick="fecharModal()"></div>
    
    <div id="modal-pedido" class="modal-sheet">
        <div class="w-12 h-1 bg-slate-600 rounded-full mx-auto mt-3 mb-2"></div>
        
        <div class="px-5 py-3 border-b border-slate-800 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold">Pedido #<span id="modal-id"></span></h3>
                <p class="text-xs text-slate-400" id="modal-data"></p>
            </div>
            <button onclick="fecharModal()" class="p-2 text-slate-400">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto px-5 py-4 space-y-4">
            <div>
                <p class="text-xs text-slate-500 uppercase">Cliente</p>
                <p class="text-lg font-semibold" id="modal-cliente"></p>
                <p class="text-sm text-slate-400" id="modal-whats"></p>
            </div>
            
            <div>
                <p class="text-xs text-slate-500 uppercase">Endereço</p>
                <p class="text-sm text-slate-300" id="modal-endereco"></p>
            </div>

            <div class="bg-slate-800/50 rounded-xl p-4">
                <p class="text-xs text-slate-500 uppercase mb-2">Itens</p>
                <div id="modal-itens" class="space-y-1"></div>
                <div class="border-t border-slate-700 pt-2 mt-2 flex justify-between items-center">
                    <span class="text-slate-400">Total</span>
                    <span class="text-xl font-bold text-emerald-400" id="modal-total"></span>
                </div>
            </div>
        </div>

        <div class="px-5 py-4 border-t border-slate-800 space-y-2 bg-slate-900/50">
            <button onclick="verCupom()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                <i class="fas fa-receipt"></i> Ver Cupom
            </button>
            
            <div class="grid grid-cols-3 gap-2">
                <button onclick="atualizarStatus('recebido')" class="bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl text-sm font-medium">
                    <i class="fas fa-check mr-1"></i> Receber
                </button>
                <button onclick="atualizarStatus('pendente')" class="bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl text-sm font-medium">
                    <i class="fas fa-clock mr-1"></i> Pendente
                </button>
                <button onclick="atualizarStatus('cancelado')" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl text-sm font-medium">
                    <i class="fas fa-times mr-1"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cupom -->
    <div id="modal-cupom-overlay" class="fixed inset-0 bg-black/80 z-60 hidden flex items-center justify-center p-4" onclick="fecharCupom(event)">
        <div class="bg-white rounded-2xl max-w-sm w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-900">Cupom Fiscal</h3>
                <button onclick="fecharCupom()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 overflow-y-auto max-h-[60vh] bg-slate-100">
                <div class="receipt-elegant rounded-xl p-6 space-y-4 bg-white">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4">
                        <h2 class="text-2xl font-bold text-slate-900">BILL RIZZO</h2>
                        <p class="text-xs text-slate-500">Loja Oficial</p>
                        <p class="text-xs text-slate-400 mt-1" id="cupom-data"></p>
                    </div>
                    
                    <div>
                        <p class="text-xs text-slate-500 uppercase">Cliente</p>
                        <p class="font-semibold text-slate-900" id="cupom-cliente"></p>
                        <p class="text-sm text-slate-600" id="cupom-telefone"></p>
                    </div>
                    
                    <div class="border-t border-b border-dashed border-slate-300 py-3 space-y-2" id="cupom-itens"></div>
                    
                    <div class="flex justify-between items-center pt-2">
                        <span class="font-bold text-slate-900">TOTAL</span>
                        <span class="text-2xl font-bold text-emerald-600" id="cupom-total"></span>
                    </div>
                    
                    <div class="text-center pt-4 border-t border-dashed border-slate-300">
                        <p class="text-xs text-slate-500">Obrigado pela preferência!</p>
                        <p class="text-[10px] text-slate-400 mt-1">Bill Rizzo Store</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-white border-t grid grid-cols-2 gap-3">
                <button onclick="compartilharCupom()" class="flex items-center justify-center gap-2 bg-slate-900 text-white py-3 rounded-xl font-semibold">
                    <i class="fas fa-share-alt"></i> Compartilhar
                </button>
                <button onclick="imprimirCupom()" class="flex items-center justify-center gap-2 bg-emerald-500 text-white py-3 rounded-xl font-semibold">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4g-r04tQ1PC72FpuNXJ8r7-1gTyD0CMc",
            authDomain: "rizzo-322b9.firebaseapp.com",
            projectId: "rizzo-322b9",
            storageBucket: "rizzo-322b9.firebasestorage.app",
            messagingSenderId: "333072750494",
            appId: "1:333072750494:web:e4638196d8bc9c5004288f"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let pedidos = [];
        let produtos = [];
        let pedidoAtual = null;
        let filtroAtual = 'todos';
        let assinaturaAtual = null;

        // Verificar assinatura
        function verificarAssinatura() {
            const q = query(collection(db, "assinaturas"), where("ativa", "==", true), orderBy("dataFim", "desc"));
            
            onSnapshot(q, (snapshot) => {
                let ativa = false;
                let diasRestantes = 0;
                let codigo = '---';
                let dataFim = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hoje = new Date();
                    const fim = data.dataFim?.toDate();
                    
                    if (fim && fim > hoje && !data.usada) {
                        ativa = true;
                        diasRestantes = Math.ceil((fim - hoje) / (1000 * 60 * 60 * 24));
                        codigo = data.codigo;
                        dataFim = fim;
                        assinaturaAtual = { id: doc.id, ...data };
                    }
                });
                
                atualizarUIAssinatura(ativa, diasRestantes, codigo, dataFim);
            });
        }

        function atualizarUIAssinatura(ativa, dias, codigo, dataFim) {
            const badge = document.getElementById('status-badge');
            const diasEl = document.getElementById('dias-restantes');
            const container = document.getElementById('days-container');
            const codigoEl = document.getElementById('codigo-atual');
            const expiraEl = document.getElementById('data-expira');
            
            if (ativa) {
                badge.innerText = 'Ativo';
                badge.className = 'px-2 py-1 rounded-full text-xs font-medium bg-emerald-500/20 text-emerald-400';
                diasEl.innerText = dias;
                codigoEl.innerText = codigo.substring(0, 8) + '...';
                expiraEl.innerText = dataFim.toLocaleDateString('pt-BR');
                
                container.classList.remove('warning', 'danger');
                if (dias <= 7) container.classList.add('danger');
                else if (dias <= 15) container.classList.add('warning');
            } else {
                badge.innerText = 'Inativo';
                badge.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-500/20 text-red-400';
                diasEl.innerText = '0';
                codigoEl.innerText = '---';
                expiraEl.innerText = '---';
                container.classList.add('danger');
            }
        }

        window.ativarNovoCodigo = async () => {
            const input = document.getElementById('novo-codigo');
            const codigo = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            if (codigo.length < 12) {
                showToast('Código inválido!', 'error');
                return;
            }

            try {
                const q = query(collection(db, "assinaturas"), where("codigo", "==", codigo), where("usada", "==", false));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showToast('Código não encontrado ou já usado!', 'error');
                    return;
                }
                
                const docRef = snapshot.docs[0].ref;
                await updateDoc(docRef, { usada: true, dataAtivacao: new Date() });
                
                input.value = '';
                showToast('Sistema ativado!');
                
            } catch (error) {
                showToast('Erro ao ativar!', 'error');
            }
        };

        // Tabs
        window.showTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-800', 'text-slate-400');
            });
            
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            activeBtn.classList.remove('bg-slate-800', 'text-slate-400');
            activeBtn.classList.add('bg-blue-600', 'text-white');
        };

        // Dashboard
        onSnapshot(query(collection(db, "pedidos"), orderBy("data", "desc")), (snapshot) => {
            pedidos = [];
            snapshot.forEach(doc => pedidos.push({ id: doc.id, ...doc.data() }));
            atualizarDashboard();
            renderizarPedidos();
        });

        onSnapshot(query(collection(db, "produtos"), orderBy("vendas", "desc")), (snapshot) => {
            produtos = [];
            const container = document.getElementById('lista-produtos');
            container.innerHTML = '';
            
            snapshot.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                produtos.push(p);
                
                const precoFinal = p.preco - (p.desconto || 0);
                container.innerHTML += `
                    <div class="mobile-card rounded-xl p-3 flex items-center gap-3">
                        ${p.imagem ? `<img src="${p.imagem}" class="w-12 h-12 rounded-lg object-cover bg-slate-800">` : 
                          `<div class="w-12 h-12 rounded-lg bg-slate-800 flex items-center justify-center text-slate-600"><i class="fas fa-image"></i></div>`}
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-white text-sm truncate">${p.nome}</h4>
                            <p class="text-xs text-slate-400">R$ ${precoFinal.toFixed(2)} ${p.desconto > 0 ? `<span class="line-through text-slate-600">R$ ${p.preco.toFixed(2)}</span>` : ''}</p>
                        </div>
                        <button onclick="toggleProduto('${doc.id}', ${p.ativo !== false})" 
                            class="px-3 py-1.5 rounded-lg text-xs font-medium ${p.ativo !== false ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700 text-slate-400'}">
                            ${p.ativo !== false ? 'Visível' : 'Oculto'}
                        </button>
                    </div>`;
            });
            
            atualizarDashboard();
        });

        function atualizarDashboard() {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const pedidosHoje = pedidos.filter(p => {
                const data = p.data?.toDate();
                return data >= hoje && p.status !== 'cancelado';
            });
            
            const pendentes = pedidos.filter(p => p.status === 'pendente').length;
            const totalHoje = pedidosHoje.reduce((acc, p) => acc + (p.totalFinal || p.total || 0), 0);
            
            document.getElementById('dash-hoje').innerText = `R$ ${totalHoje.toFixed(2)}`;
            document.getElementById('count-hoje').innerText = pedidosHoje.length;
            document.getElementById('dash-pendentes').innerText = pendentes;
            
            const badge = document.getElementById('badge-pedidos');
            badge.innerText = pendentes;
            badge.classList.toggle('hidden', pendentes === 0);
            
            // Ranking
            const ranking = {};
            pedidos.forEach(p => {
                if (p.status === 'cancelado') return;
                (p.itens || []).forEach(i => ranking[i.nome] = (ranking[i.nome] || 0) + 1);
            });
            
            const top = Object.entries(ranking).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const rankingContainer = document.getElementById('ranking-produtos');
            
            if (top.length === 0) {
                rankingContainer.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">Sem dados</p>';
            } else {
                rankingContainer.innerHTML = top.map(([nome, qtd], i) => `
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold text-slate-700 w-6">${i + 1}</span>
                        <div class="flex-1">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-slate-300">${nome}</span>
                                <span class="text-slate-500">${qtd}</span>
                            </div>
                            <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full" style="width: ${(qtd / top[0][1]) * 100}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Pedidos
        window.filtrarPedidos = (status) => {
            filtroAtual = status;
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                if (btn.dataset.filter === status) {
                    btn.classList.remove('bg-slate-800', 'text-slate-400');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.add('bg-slate-800', 'text-slate-400');
                    btn.classList.remove('bg-blue-600', 'text-white');
                }
            });
            renderizarPedidos();
        };

        function renderizarPedidos() {
            const container = document.getElementById('lista-pedidos');
            let filtrados = pedidos;
            
            if (filtroAtual !== 'todos') {
                filtrados = pedidos.filter(p => p.status === filtroAtual);
            }
            
            if (filtrados.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-8">Nenhum pedido</p>';
                return;
            }
            
            container.innerHTML = filtrados.map(p => {
                const data = p.data?.toDate() || new Date();
                const dataStr = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                const statusColors = { pendente: 'border-l-amber-500', recebido: 'border-l-emerald-500', cancelado: 'border-l-red-500' };
                
                return `
                    <div onclick="abrirPedido('${p.id}')" class="mobile-card rounded-xl p-4 border-l-4 ${statusColors[p.status || 'pendente']} active:scale-[0.98] transition-transform cursor-pointer">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-white">${p.cliente}</h4>
                                <p class="text-xs text-slate-400">${dataStr}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-emerald-400">R$ ${(p.totalFinal || p.total || 0).toFixed(2)}</p>
                                <span class="text-[10px] uppercase ${p.status === 'recebido' ? 'text-emerald-400' : p.status === 'cancelado' ? 'text-red-400' : 'text-amber-400'}">${p.status || 'pendente'}</span>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 truncate">${(p.itens || []).length} itens • ${p.endereco || 'Sem endereço'}</p>
                    </div>
                `;
            }).join('');
        }

        window.abrirPedido = (id) => {
            pedidoAtual = pedidos.find(p => p.id === id);
            if (!pedidoAtual) return;
            
            const data = pedidoAtual.data?.toDate() || new Date();
            
            document.getElementById('modal-id').innerText = id.slice(-6).toUpperCase();
            document.getElementById('modal-data').innerText = data.toLocaleString('pt-BR');
            document.getElementById('modal-cliente').innerText = pedidoAtual.cliente;
            document.getElementById('modal-whats').innerText = pedidoAtual.whats || 'Sem WhatsApp';
            document.getElementById('modal-endereco').innerText = pedidoAtual.endereco || 'Sem endereço';
            document.getElementById('modal-total').innerText = `R$ ${(pedidoAtual.totalFinal || pedidoAtual.total || 0).toFixed(2)}`;
            
            const grouped = {};
            (pedidoAtual.itens || []).forEach(item => {
                if (!grouped[item.nome]) grouped[item.nome] = { ...item, qtd: 0 };
                grouped[item.nome].qtd++;
            });
            
            document.getElementById('modal-itens').innerHTML = Object.values(grouped).map(item => `
                <div class="flex justify-between text-sm">
                    <span class="text-slate-300">${item.qtd}x ${item.nome}</span>
                    <span class="text-slate-400">R$ ${(item.preco * item.qtd).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-overlay').classList.remove('opacity-0'), 10);
            document.getElementById('modal-pedido').classList.add('active');
        };

        window.fecharModal = () => {
            document.getElementById('modal-pedido').classList.remove('active');
            document.getElementById('modal-overlay').classList.add('opacity-0');
            setTimeout(() => document.getElementById('modal-overlay').classList.add('hidden'), 300);
        };

        window.atualizarStatus = async (status) => {
            if (!pedidoAtual) return;
            
            try {
                await updateDoc(doc(db, "pedidos", pedidoAtual.id), { status });
                showToast(`Pedido ${status === 'recebido' ? 'recebido' : status === 'cancelado' ? 'cancelado' : 'pendente'}!`);
                fecharModal();
            } catch (error) {
                showToast('Erro ao atualizar!', 'error');
            }
        };

        // Cupom
        window.verCupom = () => {
            if (!pedidoAtual) return;
            
            document.getElementById('cupom-data').innerText = new Date().toLocaleString('pt-BR');
            document.getElementById('cupom-cliente').innerText = pedidoAtual.cliente;
            document.getElementById('cupom-telefone').innerText = pedidoAtual.whats || '-';
            
            const grouped = {};
            (pedidoAtual.itens || []).forEach(item => {
                if (!grouped[item.nome]) grouped[item.nome] = { ...item, qtd: 0 };
                grouped[item.nome].qtd++;
            });
            
            document.getElementById('cupom-itens').innerHTML = Object.values(grouped).map(item => `
                <div class="flex justify-between text-sm">
                    <span class="text-slate-700">${item.qtd}x ${item.nome}</span>
                    <span class="font-medium">R$ ${(item.preco * item.qtd).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById('cupom-total').innerText = `R$ ${(pedidoAtual.totalFinal || pedidoAtual.total || 0).toFixed(2)}`;
            
            document.getElementById('modal-cupom-overlay').classList.remove('hidden');
        };

        window.fecharCupom = (e) => {
            if (!e || e.target.id === 'modal-cupom-overlay') {
                document.getElementById('modal-cupom-overlay').classList.add('hidden');
            }
        };

        window.compartilharCupom = async () => {
            const texto = document.querySelector('.receipt-elegant').innerText;
            if (navigator.share) {
                try { await navigator.share({ title: 'Cupom Bill Rizzo', text: texto }); } catch (e) {}
            } else {
                navigator.clipboard.writeText(texto).then(() => showToast('Copiado!'));
            }
        };

        window.imprimirCupom = () => window.print();

        // Produtos
        window.salvarProduto = async () => {
            const nome = document.getElementById('p-nome').value.trim();
            const preco = Number(document.getElementById('p-preco').value);
            
            if (!nome || !preco) {
                showToast('Preencha nome e preço!', 'error');
                return;
            }

            const btn = document.getElementById('btn-salvar-prod');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Salvando...';
            btn.disabled = true;

            try {
                await addDoc(collection(db, "produtos"), {
                    nome,
                    preco,
                    desconto: Number(document.getElementById('p-desconto').value) || 0,
                    destaque: document.getElementById('p-destaque').checked,
                    ativo: document.getElementById('p-ativo').checked,
                    vendas: 0,
                    dataCriacao: new Date()
                });
                
                document.getElementById('p-nome').value = '';
                document.getElementById('p-preco').value = '';
                document.getElementById('p-desconto').value = '';
                showToast('Produto cadastrado!');
            } catch (error) {
                showToast('Erro ao salvar!', 'error');
            } finally {
                btn.innerHTML = '<i class="fas fa-plus mr-1"></i> Cadastrar Produto';
                btn.disabled = false;
            }
        };

        window.toggleProduto = async (id, atual) => {
            await updateDoc(doc(db, "produtos", id), { ativo: !atual });
            showToast(atual ? 'Produto oculto' : 'Produto visível');
        };

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Inicializar
        verificarAssinatura();
        showTab('dashboard');
    </script>
</body>
</html>
