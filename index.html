<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lojão PML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            color: #1f2937;
        }
        
        .product-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .product-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            background: #f9fafb;
        }
        
        .flavor-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1.5px solid #e5e7eb;
            background: white;
            color: #6b7280;
        }
        
        .flavor-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .flavor-btn.selected {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .qty-btn:active { transform: scale(0.9); }
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1.5rem 1.5rem 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .bottom-sheet.show { transform: translateY(0); }
        
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .overlay.show { opacity: 1; pointer-events: all; }
        
        .category-pill {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
            background: white;
            border: 1px solid #e5e7eb;
            color: #6b7280;
        }
        
        .category-pill.active {
            background: #1f2937;
            color: white;
            border-color: #1f2937;
        }
        
        .cart-item {
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
        }
        
        .success-check {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            animation: scaleIn 0.5s ease;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: #6366f1;
            width: 24px;
            border-radius: 4px;
        }
        
        .input-clean {
            width: 100%;
            padding: 1rem;
            border: 1.5px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }
        
        .input-clean:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .btn-primary {
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover { background: #374151; }
        .btn-primary:active { transform: scale(0.98); }
        
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .unit-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 0;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-gray-100 px-4 py-3">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-900 rounded-xl flex items-center justify-center">
                    <i class="fas fa-store text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Lojão PML</h1>
                    <p class="text-xs text-gray-500">Peça com praticidade</p>
                </div>
            </div>
            <button onclick="toggleCart()" class="relative p-2 hover:bg-gray-100 rounded-full transition">
                <i class="fas fa-shopping-bag text-xl text-gray-700"></i>
                <span id="cart-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-indigo-500 text-white text-xs rounded-full flex items-center justify-center font-bold hidden">0</span>
            </button>
        </div>
    </header>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step-dot active" id="step-dot-1"></div>
        <div class="step-dot" id="step-dot-2"></div>
        <div class="step-dot" id="step-dot-3"></div>
    </div>

    <!-- STEP 1: Produtos -->
    <div id="step-1-content" class="max-w-lg mx-auto px-4">
        <!-- Categorias -->
        <div class="flex gap-2 overflow-x-auto pb-4 mb-2 scrollbar-hide" id="category-filters">
            <button class="category-pill active" onclick="filterCategory('all')">Todos</button>
        </div>

        <!-- Lista de Produtos -->
        <div id="products-list" class="space-y-4 pb-8">
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-3xl mb-3 text-indigo-500"></i>
                <p>Carregando produtos...</p>
            </div>
        </div>
    </div>

    <!-- STEP 2: Dados -->
    <div id="step-2-content" class="max-w-lg mx-auto px-4 hidden">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <button onclick="goToStep(1)" class="text-gray-500 mb-4 flex items-center gap-2 hover:text-gray-700">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            
            <h2 class="text-xl font-bold mb-6">Seus dados</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome completo *</label>
                    <input type="text" id="client-name" class="input-clean" placeholder="Digite seu nome">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp *</label>
                    <input type="tel" id="client-phone" class="input-clean" placeholder="(11) 99999-9999" oninput="formatPhone(this)" maxlength="15">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço completo *</label>
                    <textarea id="client-address" rows="3" class="input-clean resize-none" placeholder="Rua, número, bairro, cidade..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ponto de referência</label>
                    <input type="text" id="client-reference" class="input-clean" placeholder="Ex: Casa azul, perto do mercado...">
                </div>
            </div>
            
            <button onclick="validateStep2()" class="btn-primary mt-6">
                Revisar Pedido <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- STEP 3: Revisão -->
    <div id="step-3-content" class="max-w-lg mx-auto px-4 hidden">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <button onclick="goToStep(2)" class="text-gray-500 mb-4 flex items-center gap-2 hover:text-gray-700">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            
            <h2 class="text-xl font-bold mb-6">Revise seu pedido</h2>
            
            <div id="review-items" class="space-y-3 mb-6"></div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
                <div class="flex justify-between items-center text-xl font-bold">
                    <span>Total</span>
                    <span class="text-indigo-600" id="review-total">R$ 0,00</span>
                </div>
            </div>
            
            <div id="client-data-review" class="bg-gray-50 rounded-xl p-4 mb-6 text-sm space-y-2"></div>
            
            <button onclick="submitOrder()" id="btn-submit" class="btn-primary bg-emerald-500 hover:bg-emerald-600">
                <i class="fas fa-check-circle mr-2"></i>Finalizar Pedido
            </button>
        </div>
    </div>

    <!-- Success Screen -->
    <div id="success-screen" class="max-w-lg mx-auto px-4 hidden pt-12 text-center">
        <div class="success-check">
            <i class="fas fa-check text-white text-3xl"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">Pedido Enviado!</h2>
        <p class="text-gray-600 mb-6">Seu pedido foi recebido com sucesso.</p>
        
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
            <p class="text-sm text-gray-500 mb-1">Número do pedido</p>
            <p class="text-2xl font-bold text-indigo-600" id="success-order-number">#0000</p>
        </div>
        
        <button onclick="location.reload()" class="btn-primary">
            Fazer Novo Pedido
        </button>
    </div>

    <!-- Cart Bottom Sheet -->
    <div class="overlay" id="cart-overlay" onclick="toggleCart()"></div>
    <div class="bottom-sheet" id="cart-sheet">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="font-bold text-lg">Seu Carrinho</h3>
            <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="p-4 max-h-[50vh] overflow-y-auto" id="cart-items">
            <p class="text-center text-gray-400 py-8">Carrinho vazio</p>
        </div>
        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <span class="font-bold text-lg">Total</span>
                <span class="font-bold text-xl text-indigo-600" id="cart-total">R$ 0,00</span>
            </div>
            <button onclick="closeCartAndGoToStep2()" class="btn-primary" id="cart-btn-continue" disabled>
                Continuar
            </button>
        </div>
    </div>

    <script>
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBmnd1kHE9-7uFzFpiFCbaYeMEAHPwDoXw",
            authDomain: "lojao-pml.firebaseapp.com",
            projectId: "lojao-pml",
            storageBucket: "lojao-pml.firebasestorage.app",
            messagingSenderId: "380150226397",
            appId: "1:380150226397:web:5abfd9e07a72545f75aa34"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Estado
        let cart = [];
        let products = [];
        let categories = [];
        let currentStep = 1;
        let currentCategory = 'all';

        // Carregar dados
        async function init() {
            await loadCategories();
            await loadProducts();
        }

        async function loadCategories() {
            try {
                const snap = await db.collection('categories').orderBy('name').get();
                categories = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                const container = document.getElementById('category-filters');
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'category-pill';
                    btn.textContent = cat.name;
                    btn.onclick = () => filterCategory(cat.id);
                    container.appendChild(btn);
                });
            } catch(e) {
                console.error('Erro ao carregar categorias:', e);
            }
        }

        async function loadProducts() {
            try {
                const snap = await db.collection('products').where('available', '!=', false).get();
                products = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderProducts();
            } catch(e) {
                console.error('Erro ao carregar produtos:', e);
                document.getElementById('products-list').innerHTML = 
                    '<div class="text-center py-12 text-gray-400"><p>Erro ao carregar produtos</p></div>';
            }
        }

        function renderProducts() {
            const container = document.getElementById('products-list');
            container.innerHTML = '';
            
            let filtered = products;
            if(currentCategory !== 'all') {
                filtered = products.filter(p => p.category === currentCategory);
            }
            
            if(filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-box-open text-4xl mb-3"></i><p>Nenhum produto</p></div>';
                return;
            }
            
            filtered.forEach(product => {
                const hasFlavors = product.hasFlavors && product.flavors && product.flavors.length > 0;
                const unitText = product.units ? `${product.units} un` : null;
                const unitPrice = product.units && product.units > 1 ? (product.price / product.units).toFixed(2) : null;
                
                const div = document.createElement('div');
                div.className = 'product-card';
                div.innerHTML = `
                    ${product.image ? `<img src="${product.image}" class="product-image" alt="${product.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : ''}
                    <div class="product-image flex items-center justify-center bg-gray-100 ${product.image ? 'hidden' : ''}">
                        <i class="fas fa-box text-4xl text-gray-300"></i>
                    </div>
                    
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900 mb-1">${product.name}</h3>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-lg font-bold text-indigo-600">${formatMoney(product.price)}</span>
                                    ${unitText ? `<span class="unit-badge">${unitText}</span>` : ''}
                                </div>
                                ${unitPrice ? `<p class="text-xs text-gray-500 mb-2">${formatMoney(unitPrice)} por unidade</p>` : ''}
                            </div>
                        </div>
                        
                        ${product.description ? `<p class="text-sm text-gray-500 mb-3 line-clamp-2">${product.description}</p>` : ''}
                        
                        ${hasFlavors ? `
                            <div class="mb-3">
                                <p class="text-xs text-gray-500 mb-2">Escolha o sabor:</p>
                                <div class="flex flex-wrap gap-2" id="flavors-${product.id}">
                                    ${product.flavors.map((flavor, idx) => `
                                        <button class="flavor-btn ${idx === 0 ? 'selected' : ''}" 
                                                onclick="selectFlavor('${product.id}', '${flavor.name}', ${flavor.price || product.price}, this)"
                                                data-flavor="${flavor.name}"
                                                data-price="${flavor.price || product.price}">
                                            ${flavor.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                            <div class="flex items-center gap-3 bg-gray-100 rounded-full px-2 py-1">
                                <button onclick="updateQty('${product.id}', -1)" class="qty-btn bg-white text-gray-700 shadow-sm hover:bg-gray-50">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <span class="w-6 text-center font-bold text-sm" id="qty-${product.id}">0</span>
                                <button onclick="updateQty('${product.id}', 1)" class="qty-btn bg-indigo-600 text-white shadow-md hover:bg-indigo-700">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                            <span class="text-xs text-gray-500" id="selected-flavor-${product.id}">
                                ${hasFlavors ? product.flavors[0].name : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
                
                // Inicializa sabor selecionado
                if(hasFlavors) {
                    const firstFlavor = product.flavors[0];
                    updateCartItem(product.id, product.name, 0, firstFlavor.name, firstFlavor.price || product.price, product.image, product.units);
                } else {
                    updateCartItem(product.id, product.name, 0, null, product.price, product.image, product.units);
                }
            });
        }

        function selectFlavor(productId, flavorName, flavorPrice, btn) {
            // Atualiza UI
            const container = document.getElementById(`flavors-${productId}`);
            container.querySelectorAll('.flavor-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            document.getElementById(`selected-flavor-${productId}`).textContent = flavorName;
            
            // Atualiza carrinho
            const product = products.find(p => p.id === productId);
            const currentQty = getCartQty(productId);
            updateCartItem(productId, product.name, currentQty, flavorName, flavorPrice, product.image, product.units);
            
            updateCartUI();
        }

        function updateQty(productId, change) {
            const product = products.find(p => p.id === productId);
            const hasFlavors = product.hasFlavors && product.flavors && product.flavors.length > 0;
            
            // Pega sabor selecionado atual
            let selectedFlavor = null;
            let selectedPrice = product.price;
            
            if(hasFlavors) {
                const container = document.getElementById(`flavors-${productId}`);
                const selectedBtn = container.querySelector('.flavor-btn.selected');
                if(selectedBtn) {
                    selectedFlavor = selectedBtn.dataset.flavor;
                    selectedPrice = parseFloat(selectedBtn.dataset.price);
                }
            }
            
            const currentQty = getCartQty(productId);
            const newQty = Math.max(0, currentQty + change);
            
            document.getElementById(`qty-${productId}`).textContent = newQty;
            updateCartItem(productId, product.name, newQty, selectedFlavor, selectedPrice, product.image, product.units);
            
            updateCartUI();
        }

        function getCartQty(productId) {
            const item = cart.find(i => i.id === productId);
            return item ? item.qty : 0;
        }

        function updateCartItem(id, name, qty, flavor, price, image, units) {
            const existingIndex = cart.findIndex(i => i.id === id);
            
            if(qty === 0) {
                if(existingIndex > -1) cart.splice(existingIndex, 1);
            } else {
                const item = {
                    id,
                    name,
                    qty,
                    flavor,
                    price,
                    image,
                    units,
                    total: price * qty
                };
                
                if(existingIndex > -1) {
                    cart[existingIndex] = item;
                } else {
                    cart.push(item);
                }
            }
        }

        function updateCartUI() {
            const total = cart.reduce((sum, item) => sum + item.total, 0);
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            
            document.getElementById('cart-total').textContent = formatMoney(total);
            
            const badge = document.getElementById('cart-badge');
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
            
            const btn = document.getElementById('cart-btn-continue');
            btn.disabled = count === 0;
            btn.style.opacity = count === 0 ? '0.5' : '1';
            
            // Renderiza itens do carrinho
            const container = document.getElementById('cart-items');
            if(cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">Carrinho vazio</p>';
            } else {
                container.innerHTML = cart.map(item => `
                    <div class="cart-item flex gap-3">
                        ${item.image ? `<img src="${item.image}" class="w-16 h-16 object-cover rounded-lg bg-gray-100" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : ''}
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center ${item.image ? 'hidden' : ''}">
                            <i class="fas fa-box text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm mb-1">${item.name}</h4>
                            ${item.flavor ? `<p class="text-xs text-indigo-600 mb-1">${item.flavor}</p>` : ''}
                            <p class="text-xs text-gray-500">${item.qty}x ${formatMoney(item.price)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-indigo-600">${formatMoney(item.total)}</p>
                            <button onclick="removeFromCart('${item.id}')" class="text-xs text-red-500 mt-1">Remover</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function removeFromCart(productId) {
            const item = cart.find(i => i.id === productId);
            if(item) {
                const qtyEl = document.getElementById(`qty-${productId}`);
                if(qtyEl) qtyEl.textContent = '0';
                updateCartItem(productId, item.name, 0, item.flavor, item.price, item.image, item.units);
                updateCartUI();
            }
        }

        function filterCategory(catId) {
            currentCategory = catId;
            document.querySelectorAll('.category-pill').forEach(btn => {
                const isActive = (catId === 'all' && btn.textContent === 'Todos') ||
                    categories.find(c => c.id === catId)?.name === btn.textContent;
                btn.classList.toggle('active', isActive);
            });
            renderProducts();
        }

        function toggleCart() {
            document.getElementById('cart-overlay').classList.toggle('show');
            document.getElementById('cart-sheet').classList.toggle('show');
        }

        function closeCartAndGoToStep2() {
            toggleCart();
            goToStep(2);
        }

        function goToStep(step) {
            currentStep = step;
            
            // Atualiza indicadores
            for(let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`step-dot-${i}`);
                if(dot) dot.classList.toggle('active', i <= step);
            }
            
            // Esconde todos os conteúdos
            ['step-1-content', 'step-2-content', 'step-3-content'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            
            // Mostra o conteúdo atual
            const currentContent = document.getElementById(`step-${step}-content`);
            if(currentContent) currentContent.classList.remove('hidden');
            
            if(step === 3) renderReview();
        }

        function validateStep2() {
            const name = document.getElementById('client-name').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const address = document.getElementById('client-address').value.trim();
            
            if(!name) return alert('Digite seu nome');
            if(!phone || phone.replace(/\D/g, '').length < 10) return alert('Digite um telefone válido');
            if(!address) return alert('Digite seu endereço');
            
            goToStep(3);
        }

        function renderReview() {
            const container = document.getElementById('review-items');
            container.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                    <div>
                        <p class="font-bold text-sm">${item.qty}x ${item.name}</p>
                        ${item.flavor ? `<p class="text-xs text-indigo-600">${item.flavor}</p>` : ''}
                    </div>
                    <span class="font-bold text-indigo-600">${formatMoney(item.total)}</span>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, item) => sum + item.total, 0);
            document.getElementById('review-total').textContent = formatMoney(total);
            
            const name = document.getElementById('client-name').value;
            const phone = document.getElementById('client-phone').value;
            const address = document.getElementById('client-address').value;
            const reference = document.getElementById('client-reference').value;
            
            document.getElementById('client-data-review').innerHTML = `
                <p><strong>${name}</strong></p>
                <p class="text-gray-600">${phone}</p>
                <p class="text-gray-600">${address}</p>
                ${reference ? `<p class="text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${reference}</p>` : ''}
            `;
        }

        async function submitOrder() {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
            
            try {
                // Gera número do pedido baseado no timestamp
                const timestamp = Date.now();
                const orderNumber = String(timestamp).slice(-4);
                
                const orderData = {
                    orderNumber,
                    clientName: document.getElementById('client-name').value.trim(),
                    clientPhone: document.getElementById('client-phone').value.trim(),
                    clientAddress: document.getElementById('client-address').value.trim(),
                    clientReference: document.getElementById('client-reference').value.trim(),
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        flavor: item.flavor,
                        price: item.price,
                        qty: item.qty,
                        total: item.total
                    })),
                    total: cart.reduce((sum, item) => sum + item.total, 0),
                    status: 'pending',
                    paid: false,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'website'
                };
                
                await db.collection('orders').add(orderData);
                
                document.getElementById('step-3-content').classList.add('hidden');
                document.querySelector('.step-indicator').classList.add('hidden');
                document.getElementById('success-screen').classList.remove('hidden');
                document.getElementById('success-order-number').textContent = '#' + orderNumber;
                
            } catch(error) {
                console.error(error);
                alert('Erro ao enviar pedido. Tente novamente.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Finalizar Pedido';
            }
        }

        function formatMoney(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            if(value.length > 11) value = value.slice(0, 11);
            
            if(value.length > 7) {
                input.value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
            } else if(value.length > 2) {
                input.value = `(${value.slice(0,2)}) ${value.slice(2)}`;
            } else if(value.length > 0) {
                input.value = `(${value}`;
            }
        }

        // Inicializar
        init();
    </script>
</body>
</html>
